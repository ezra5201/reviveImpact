<!DOCTYPE html>
<html lang="en">
<head>
  <base target="_top">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ReVive Engagement Center - New Visitor Intake Form</title>
  <style>
    * {
      box-sizing: border-box;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }
    
    body {
      margin: 0;
      padding: 0;
      background-color: #f5f5f5;
      color: #333;
    }
    
    .container {
      max-width: 800px;
      margin: 0 auto;
      padding: 20px;
      background-color: #fff;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      background-color: #f8f8f8;
      padding: 15px 20px;
      margin-bottom: 20px;
      border-bottom: 1px solid #e0e0e0;
    }
    
    .header h1 {
      margin: 0;
      color: #2c3e50;
    }
    
    .user-info {
      display: flex;
      align-items: center;
    }
    
    .user-info span {
      margin-right: 15px;
    }
    
    .user-info button {
      padding: 5px 10px;
      background-color: #e74c3c;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    
    .form-title {
      color: #2c3e50;
      margin-bottom: 5px;
    }
    
    .form-subtitle {
      color: #7f8c8d;
      margin-top: 0;
      margin-bottom: 20px;
      font-style: italic;
    }
    
    .form-section {
      margin-bottom: 25px;
      padding: 15px;
      border: 1px solid #e0e0e0;
      border-radius: 5px;
      background-color: #f9f9f9;
    }
    
    .form-group {
      margin-bottom: 15px;
    }
    
    .form-group label {
      display: block;
      margin-bottom: 5px;
      font-weight: bold;
    }
    
    .form-control {
      width: 100%;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 16px;
    }
    
    textarea.form-control {
      min-height: 100px;
      resize: vertical;
    }
    
    .checkbox-group {
      margin-bottom: 10px;
    }
    
    .checkbox-group label {
      display: flex;
      align-items: center;
      margin-bottom: 5px;
      font-weight: normal;
    }
    
    .checkbox-group input[type="checkbox"],
    .radio-group input[type="radio"] {
      margin-right: 10px;
    }
    
    .nested-options {
      margin-left: 30px;
      margin-top: 10px;
      padding-left: 10px;
      border-left: 2px solid #3498db;
    }
    
    .nested-options .checkbox-group {
      margin-bottom: 5px;
    }
    
    .radio-group {
      margin-bottom: 10px;
    }
    
    .radio-group label {
      display: flex;
      align-items: center;
      margin-bottom: 5px;
      font-weight: normal;
    }
    
    .alert-info {
      background-color: #d1ecf1;
      color: #0c5460;
      padding: 10px 15px;
      border-radius: 4px;
      margin-top: 5px;
      border-left: 4px solid #0c5460;
    }
    
    .demographics-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 15px;
    }
    
    .form-buttons {
      display: flex;
      justify-content: space-between;
      margin-top: 30px;
    }
    
    .btn {
      padding: 10px 20px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 16px;
      font-weight: bold;
    }
    
    .btn-primary {
      background-color: #3498db;
      color: white;
    }
    
    .btn-secondary {
      background-color: #7f8c8d;
      color: white;
    }
    
    .required-field::after {
      content: "*";
      color: red;
      margin-left: 3px;
    }
    
    .form-footer {
      margin-top: 20px;
      color: #7f8c8d;
      font-size: 14px;
      text-align: center;
    }
    
    .loading {
      display: none;
      text-align: center;
      padding: 20px;
    }
    
    .loading-spinner {
      border: 5px solid #f3f3f3;
      border-top: 5px solid #3498db;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 2s linear infinite;
      margin: 0 auto 10px;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    .form-result {
      display: none;
      margin-top: 20px;
      padding: 20px;
      border-radius: 5px;
      text-align: center;
    }
    
    .form-result.success {
      background-color: #d4edda;
      border: 1px solid #c3e6cb;
      color: #155724;
    }
    
    .form-result.error {
      background-color: #f8d7da;
      border: 1px solid #f5c6cb;
      color: #721c24;
    }
  </style>
</head>
<body>
  <div class="header">
    <h1>REVIVE</h1>
    <div class="user-info">
      <span id="userEmail">Loading...</span>
      <button onclick="google.script.host.close()">Close</button>
    </div>
  </div>

  <div class="container">
    <h2 class="form-title">Center New Visitor Intake</h2>
    <p class="form-subtitle">Complete during first visit (~5 mins)</p>
    
    <div id="formContainer">
      <form id="intakeForm" onsubmit="handleFormSubmit(this); return false;">
        <!-- Basic Information Section -->
        <div class="form-section">
          <div class="form-group">
            <label for="name" class="required-field">1. Name (Individual / Family)</label>
            <input type="text" id="name" name="name" class="form-control" required>
          </div>
          
          <div class="form-group">
            <label for="referralSource" class="required-field">2. How did you hear about us?</label>
            <select id="referralSource" name="referralSource" class="form-control" required>
              <option value="">-- Please select --</option>
              <option value="friend">Friend/Family</option>
              <option value="agency">Another Agency</option>
              <option value="web">Website/Internet Search</option>
              <option value="outreach">Street Outreach Team</option>
              <option value="hospital">Hospital/Healthcare Provider</option>
              <option value="other">Other</option>
            </select>
          </div>
          
          <div class="form-group">
            <label for="supportNeeds" class="required-field">3. What support do you hope to have at ReVive's Engagement Center?</label>
            <textarea id="supportNeeds" name="supportNeeds" class="form-control" required></textarea>
          </div>
        </div>
        
        <!-- Housing Status Section -->
        <div class="form-section">
          <div class="form-group">
            <label class="required-field">4. Current Housing Status:</label>
            
            <div class="radio-group">
              <label>
                <input type="radio" name="currentHousing" value="unstable" required>
                a. Unstably housed
              </label>
              
              <div class="nested-options" id="housingBarriersSection">
                <p>Defined by following barriers:</p>
                <div class="checkbox-group">
                  <label>
                    <input type="checkbox" name="housingBarriers" value="eviction">
                    Risk of eviction
                  </label>
                </div>
                <div class="checkbox-group">
                  <label>
                    <input type="checkbox" name="housingBarriers" value="landlord">
                    Landlord issues
                  </label>
                </div>
                <div class="checkbox-group">
                  <label>
                    <input type="checkbox" name="housingBarriers" value="dv">
                    DV issues
                  </label>
                </div>
                <div class="checkbox-group">
                  <label>
                    <input type="checkbox" name="housingBarriers" value="rent">
                    Trouble paying rent
                  </label>
                </div>
                <div class="checkbox-group">
                  <label>
                    <input type="checkbox" name="housingBarriers" value="managing">
                    Managing my home
                  </label>
                </div>
                <div class="checkbox-group">
                  <label>
                    <input type="checkbox" name="housingBarriers" value="disability">
                    Disability affecting me from living safely / staying in my home
                  </label>
                </div>
                <div class="checkbox-group">
                  <label>
                    <input type="checkbox" name="housingBarriers" value="other">
                    Other
                  </label>
                  <input type="text" name="housingBarrierOther" class="form-control" placeholder="Please specify" style="margin-top: 5px;">
                </div>
              </div>
            </div>
            
            <div class="radio-group">
              <label>
                <input type="radio" name="currentHousing" value="couchSurfing">
                b. Couch surfing
              </label>
            </div>
            
            <div class="radio-group">
              <label>
                <input type="radio" name="currentHousing" value="shelter">
                c. In a emergency shelter
              </label>
            </div>
            
            <div class="radio-group">
              <label>
                <input type="radio" name="currentHousing" value="unsheltered">
                d. Unsheltered (train, tent, abandoned building)
              </label>
            </div>
            
            <div class="radio-group">
              <label>
                <input type="radio" name="currentHousing" value="none">
                e. None of the above
              </label>
            </div>
          </div>
        </div>
        
        <!-- Past Housing Section -->
        <div class="form-section">
          <div class="form-group">
            <label class="required-field">5. Past Housing Status:</label>
            
            <div class="radio-group">
              <label>
                <input type="radio" name="pastHousing" value="experienced" required>
                a. Have experienced homelessness or housing instability
              </label>
            </div>
            
            <div class="radio-group">
              <label>
                <input type="radio" name="pastHousing" value="na">
                b. N/A
              </label>
            </div>
          </div>
          
          <div class="alert-info">
            <strong>Note:</strong> If yes to 4a or 5a → can enroll in SHP
          </div>
        </div>
        
        <!-- CM-Identified Information Section -->
        <div class="form-section">
          <h3>6. CM-Identified Information (indicate if client or staff identified)</h3>
          <p>Demographics:</p>
          
          <div class="demographics-grid">
            <div class="form-group">
              <label for="race">a. Race</label>
              <select id="race" name="race" class="form-control">
                <option value="">-- Please select --</option>
                <option value="americanIndian">American Indian/Alaska Native</option>
                <option value="asian">Asian</option>
                <option value="black">Black/African American</option>
                <option value="hawaiian">Native Hawaiian/Pacific Islander</option>
                <option value="white">White</option>
                <option value="multiracial">Multiracial</option>
                <option value="other">Other</option>
              </select>
            </div>
            
            <div class="form-group">
              <label for="ethnicity">b. Ethnicity</label>
              <select id="ethnicity" name="ethnicity" class="form-control">
                <option value="">-- Please select --</option>
                <option value="hispanic">Hispanic/Latino</option>
                <option value="nonHispanic">Non-Hispanic/Latino</option>
              </select>
            </div>
            
            <div class="form-group">
              <label for="language">c. Language</label>
              <select id="language" name="language" class="form-control">
                <option value="">-- Please select --</option>
                <option value="english">English</option>
                <option value="spanish">Spanish</option>
                <option value="other">Other</option>
              </select>
            </div>
            
            <div class="form-group">
              <label for="gender">d. Gender</label>
              <select id="gender" name="gender" class="form-control">
                <option value="">-- Please select --</option>
                <option value="female">Female</option>
                <option value="male">Male</option>
                <option value="transgender">Transgender</option>
                <option value="nonBinary">Non-binary</option>
                <option value="other">Other</option>
              </select>
            </div>
            
            <div class="form-group">
              <label for="pronouns">e. Pronouns</label>
              <select id="pronouns" name="pronouns" class="form-control">
                <option value="">-- Please select --</option>
                <option value="she">She/Her</option>
                <option value="he">He/Him</option>
                <option value="they">They/Them</option>
                <option value="other">Other</option>
              </select>
            </div>
            
            <div class="form-group">
              <label for="disability">f. Disability</label>
              <select id="disability" name="disability" class="form-control">
                <option value="">-- Please select --</option>
                <option value="yes">Yes</option>
                <option value="no">No</option>
              </select>
            </div>
            
            <div class="form-group">
              <label for="veteran">g. Veteran</label>
              <select id="veteran" name="veteran" class="form-control">
                <option value="">-- Please select --</option>
                <option value="yes">Yes</option>
                <option value="no">No</option>
              </select>
            </div>
            
            <div class="form-group">
              <label for="dob">h. DOB or birth year</label>
              <input type="date" id="dob" name="dob" class="form-control">
            </div>
            
            <div class="form-group">
              <label>i. Documentation needs for housing</label>
              <div class="checkbox-group">
                <label>
                  <input type="checkbox" name="documentationNeeds" value="id">
                  ID
                </label>
              </div>
              <div class="checkbox-group">
                <label>
                  <input type="checkbox" name="documentationNeeds" value="ssCard">
                  SS card
                </label>
              </div>
              <div class="checkbox-group">
                <label>
                  <input type="checkbox" name="documentationNeeds" value="other">
                  Other
                </label>
                <input type="text" name="documentationNeedsOther" class="form-control" placeholder="Please specify" style="margin-top: 5px;">
              </div>
            </div>
            
            <div class="form-group">
              <label for="employmentStatus">j. Employment status / need</label>
              <select id="employmentStatus" name="employmentStatus" class="form-control">
                <option value="">-- Please select --</option>
                <option value="sufficientlyEmployed">Sufficiently employed</option>
                <option value="underemployed">Underemployed</option>
                <option value="unemployed">Unemployed</option>
              </select>
            </div>
            
            <div class="form-group">
              <label for="incomeStatus">k. Income status / need</label>
              <select id="incomeStatus" name="incomeStatus" class="form-control">
                <option value="">-- Please select --</option>
                <option value="noIncome">No income</option>
                <option value="lowIncome">Low income</option>
                <option value="earnedIncome">Earned income</option>
                <option value="disability">On disability</option>
              </select>
            </div>
          </div>
          
          <div class="alert-info">
            <strong>Note:</strong> If yes to 4e and 7k (has stable and sufficient income) → refer to Sharrise to explore other resources / not qualified for some onsite supports (e.g., laundry)
          </div>
        </div>
        
        <!-- Form Buttons -->
        <div class="form-buttons">
          <button type="button" class="btn btn-secondary" onclick="resetForm()">Reset</button>
          <button type="submit" class="btn btn-primary">Submit</button>
        </div>
      </form>
    </div>
    
    <div id="loadingSection" class="loading">
      <div class="loading-spinner"></div>
      <p>Processing your submission...</p>
    </div>
    
    <div id="resultSection" class="form-result">
      <h3 id="resultTitle"></h3>
      <p id="resultMessage"></p>
      <div id="additionalInfo"></div>
      <button type="button" class="btn btn-primary" onclick="resetForm()">Submit Another</button>
    </div>
    
    <div class="form-footer">
      <p>* Required fields | Form ID: INTAKE-2025-03</p>
    </div>
  </div>

  <script>
    // Load user information when the page loads
    document.addEventListener('DOMContentLoaded', function() {
      google.script.run
        .withSuccessHandler(updateUserInfo)
        .withFailureHandler(handleError)
        .getUser();
        
      // Initially hide the housing barriers section
      document.getElementById('housingBarriersSection').style.display = 'none';
      
      // Add event listener for current housing radio buttons
      var housingRadios = document.getElementsByName('currentHousing');
      for(var i = 0; i < housingRadios.length; i++) {
        housingRadios[i].addEventListener('change', toggleHousingBarriers);
      }
    });
    
    // Update the user info in the header
    function updateUserInfo(email) {
      document.getElementById('userEmail').textContent = email;
    }
    
    // Toggle housing barriers section visibility
    function toggleHousingBarriers() {
      var housingBarriersSection = document.getElementById('housingBarriersSection');
      if(this.value === 'unstable') {
        housingBarriersSection.style.display = 'block';
      } else {
        housingBarriersSection.style.display = 'none';
        
        // Uncheck all checkboxes in the section
        var checkboxes = housingBarriersSection.querySelectorAll('input[type="checkbox"]');
        for(var i = 0; i < checkboxes.length; i++) {
          checkboxes[i].checked = false;
        }
        
        // Clear text inputs in the section
        var textInputs = housingBarriersSection.querySelectorAll('input[type="text"]');
        for(var i = 0; i < textInputs.length; i++) {
          textInputs[i].value = '';
        }
      }
    }
    
    // Handle form submission
    function handleFormSubmit(formObject) {
      // Show loading indicator
      document.getElementById('formContainer').style.display = 'none';
      document.getElementById('loadingSection').style.display = 'block';
      
      // Simplify our approach - serialize the form manually
      var formData = {
        // Basic info
        name: document.getElementById('name').value,
        referralSource: document.getElementById('referralSource').value,
        supportNeeds: document.getElementById('supportNeeds').value,
        
        // Current housing
        currentHousing: getRadioValue('currentHousing'),
        
        // Housing barriers - only if unstably housed
        housingBarriers: getCheckedValues('housingBarriers'),
        housingBarrierOther: document.querySelector('input[name="housingBarrierOther"]').value,
        
        // Past housing
        pastHousing: getRadioValue('pastHousing'),
        
        // Demographics
        race: document.getElementById('race').value,
        ethnicity: document.getElementById('ethnicity').value,
        language: document.getElementById('language').value,
        gender: document.getElementById('gender').value,
        pronouns: document.getElementById('pronouns').value,
        disability: document.getElementById('disability').value,
        veteran: document.getElementById('veteran').value,
        dob: document.getElementById('dob').value,
        
        // Documentation needs
        documentationNeeds: getCheckedValues('documentationNeeds'),
        documentationNeedsOther: document.querySelector('input[name="documentationNeedsOther"]').value,
        
        // Employment and income
        employmentStatus: document.getElementById('employmentStatus').value,
        incomeStatus: document.getElementById('incomeStatus').value
      };
      
      // Helper function to get the value of a selected radio button
      function getRadioValue(name) {
        var radios = document.getElementsByName(name);
        for (var i = 0; i < radios.length; i++) {
          if (radios[i].checked) {
            return radios[i].value;
          }
        }
        return '';
      }
      
      // Helper function to get all checked values for checkboxes with the same name
      function getCheckedValues(name) {
        var checkboxes = document.getElementsByName(name);
        var values = [];
        for (var i = 0; i < checkboxes.length; i++) {
          if (checkboxes[i].checked) {
            values.push(checkboxes[i].value);
          }
        }
        return values;
      }
      
      // Send form to server
      google.script.run
        .withSuccessHandler(showSuccess)
        .withFailureHandler(showError)
        .processForm(formData);
    }
    
    // Display success message
    function showSuccess(result) {
      // Hide loading indicator
      document.getElementById('loadingSection').style.display = 'none';
      
      // Show result section
      var resultSection = document.getElementById('resultSection');
      resultSection.style.display = 'block';
      resultSection.className = 'form-result success';
      
      // Update result content
      document.getElementById('resultTitle').textContent = 'Form Submitted Successfully!';
      document.getElementById('resultMessage').textContent = result.message;
      
      // Add additional information based on eligibility
      var additionalInfo = document.getElementById('additionalInfo');
      additionalInfo.innerHTML = '';
      
      if(result.canEnrollSHP) {
        var shpInfo = document.createElement('div');
        shpInfo.className = 'alert-info';
        shpInfo.innerHTML = '<strong>Note:</strong> This client is eligible for SHP enrollment.';
        additionalInfo.appendChild(shpInfo);
      }
      
      if(result.needsReferral) {
        var referralInfo = document.createElement('div');
        referralInfo.className = 'alert-info';
        referralInfo.innerHTML = '<strong>Action Required:</strong> Please refer this client to Sharrise to explore other resources.';
        additionalInfo.appendChild(referralInfo);
      }
    }
    
    // Display error message
    function showError(error) {
      // Hide loading indicator
      document.getElementById('loadingSection').style.display = 'none';
      
      // Show result section
      var resultSection = document.getElementById('resultSection');
      resultSection.style.display = 'block';
      resultSection.className = 'form-result error';
      
      // Update result content
      document.getElementById('resultTitle').textContent = 'Error';
      document.getElementById('resultMessage').textContent = 'There was an error processing your form: ' + error.message;
      document.getElementById('additionalInfo').innerHTML = '';
    }
    
    // Generic error handler
    function handleError(error) {
      console.error('Error:', error);
      alert('An error occurred: ' + error);
    }
    
    // Reset the form and UI state
    function resetForm() {
      document.getElementById('intakeForm').reset();
      document.getElementById('housingBarriersSection').style.display = 'none';
      document.getElementById('formContainer').style.display = 'block';
      document.getElementById('resultSection').style.display = 'none';
    }
  </script>
</body>
</html>
