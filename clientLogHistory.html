document.addEventListener('DOMContentLoaded', function() {
  // Store client name for passing to the dialog
  window.currentClientName = document.getElementById('clientNameHeader').textContent.trim();
  
  // Get dialog elements
  const followupDialogOverlay = document.getElementById('followupDialogOverlay');
  const followupFormIframe = document.getElementById('followupFormIframe');
  const closeFollowupDialog = document.getElementById('closeFollowupDialog');
  
  // Add CM Followup button functionality
  const addFollowupBtn = document.getElementById('addFollowupBtn');
  if (addFollowupBtn) {
    addFollowupBtn.addEventListener('click', function() {
      openFollowupDialog();
    });
  }
  
  // Close dialog button
  closeFollowupDialog.addEventListener('click', function() {
    hideFollowupDialog();
  });
  
  // Function to open the followup dialog
  function openFollowupDialog(referenceDate = null) {
    // Extract client name from header (remove the age in parentheses)
    const clientName = window.currentClientName.replace(/\s*\(\d+\)$/, '');
    
    // Set the iframe source
    const params = new URLSearchParams();
    params.append('client', clientName);
    
    if (referenceDate) {
      params.append('referenceDate', referenceDate);
    }
    
    // Set the iframe source to CM-Dialog.html with parameters
    followupFormIframe.src = `CM-Dialog.html?${params.toString()}`;
    
    // Show the dialog
    followupDialogOverlay.style.display = 'flex';
    
    // Disable scrolling on the main page
    document.body.style.overflow = 'hidden';
  }
  
  // Function to close the followup dialog
  function hideFollowupDialog() {
    // Hide the dialog
    followupDialogOverlay.style.display = 'none';
    
    // Clear the iframe source
    followupFormIframe.src = 'about:blank';
    
    // Re-enable scrolling
    document.body.style.overflow = 'auto';
  }
  
  // Callback function for when followup is submitted (called from iframe)
  window.onFollowupSubmitted = function() {
    hideFollowupDialog();
    
    // Refresh the client history table
    // In a real implementation, this would reload data from the server
    alert('Followup submitted successfully! The meeting history will be updated.');
  };
  
  // Make table headers sortable
  const sortableHeaders = document.querySelectorAll('th.sortable');
  sortableHeaders.forEach(header => {
    header.addEventListener('click', function() {
      // Sort implementation would go here
      // For demonstration, we'll just toggle the arrow
      if (this.textContent.includes('↓')) {
        this.textContent = this.textContent.replace('↓', '↑');
      } else {
        this.textContent = this.textContent.replace('↑', '↓');
      }
    });
  });
  
  // View meeting buttons
  const viewMeetingButtons = document.querySelectorAll('.view-meeting-btn');
  viewMeetingButtons.forEach(button => {
    button.addEventListener('click', function() {
      const date = this.closest('tr').querySelector('td:first-child').textContent;
      alert(`Viewing meeting details for ${date}`);
      // In a real implementation, this would open a read-only view of the meeting
    });
  });
});
