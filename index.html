<!DOCTYPE html>
<html lang="en">
<head>
  <!-- ==========================================================================
       META TAGS & DOCUMENT SETUP
       ========================================================================== -->
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ReVive Contact Log</title>
  <link rel="stylesheet" href="styles.css">
</head>

<body>
  
  <!-- ==========================================================================
       HEADER WILL BE LOADED HERE BY HeaderManager
       ========================================================================== -->
  <!-- Header content will be inserted here automatically -->

  <!-- ==========================================================================
       MAIN DATA TABLE CONTAINER
       ========================================================================== -->
  <div class="table-container">
    <!-- Scrollable Content -->
    <div class="table-content">
      <div class="table-rows-container">

        <!-- ==========================================================================
             TABLE HEADER ROW - STICKY HEADERS
             ========================================================================== -->
        <div class="table-row">
          <!-- Fixed Columns Header -->
          <div class="fixed-columns">
            <div class="column-header col-date">Date ↓</div>
            <div class="column-header col-days">Days Ago ↓</div>
            <div class="column-header col-provider">Provider ↓</div>
            <div class="column-header col-client">Client ↓</div>
          </div>

          <!-- Scrollable Columns Header -->
          <div class="scrollable-columns">
            <div class="column-header col-service">Place of Service ↓</div>
            <div class="column-header col-accompanied">Accompanied Appointment? ↓</div>
            <div class="column-header col-documentation">Obtained Documentation ↓</div>
            <div class="column-header col-resources">Resources Given ↓</div>
            <div class="column-header col-health">On-Site Health Care Received ↓</div>
            <div class="column-header col-program">Program Started ↓</div>
            <div class="column-header col-housing">Housing Entered ↓</div>
            <div class="column-header col-counted">? (Counted Columns) ↓</div>
            <div class="column-header col-notes">Notes ↓</div>
            <div class="column-header col-status">Program at Status ↓</div>
          </div>
        </div>

        <!-- ==========================================================================
             DYNAMIC DATA ROWS - LOADED FROM JSON
             ========================================================================== -->
        <!-- Table rows will be dynamically generated here -->

      </div>
    </div>
  </div>
        
  <!-- ==========================================================================
       JAVASCRIPT INITIALIZATION
       ========================================================================== -->

  <!-- Load the required JavaScript files -->
  <script src="page-configs.js"></script>
  <script src="header-manager.js"></script>

  <!-- Initialize header for this page -->
  <script>
document.addEventListener('DOMContentLoaded', async function() {
  // Load table data immediately (independent of header)
  loadContactLogData();
  
  // Initialize table drag scrolling
  initializeTableDragScrolling();
  
  // Set up page-specific search callback
  window.onClientSelected = function(clientName) {
    filterTableByClient(clientName);
  };
  
  // Try to initialize header (but don't let it break the page)
  try {
    await HeaderManager.init(PageConfigs.contactLog);
  } catch (error) {
    console.error('Header initialization failed, but page continues:', error);
  }
});
  </script>

  <!-- Data Loading and Table Generation Script -->
  <script>
    // Global variable to store contact log data
    let contactLogData = [];

    // Load data from JSON file and populate table
    async function loadContactLogData() {
      try {
        const response = await fetch('contact-log-data.json');
        const data = await response.json();
        contactLogData = data.contactLogEntries;
        populateTable(contactLogData);
      } catch (error) {
        console.error('Error loading contact log data:', error);
        showErrorMessage();
      }
    }

    // Generate table rows from data
    function populateTable(entries) {
      const tableRowsContainer = document.querySelector('.table-rows-container');
      
      // Clear existing rows (keep header)
      const existingRows = tableRowsContainer.querySelectorAll('.table-row:not(:first-child)');
      existingRows.forEach(row => row.remove());

      // Generate rows from data
      entries.forEach(entry => {
        const row = createTableRow(entry);
        tableRowsContainer.appendChild(row);
      });

      // Re-initialize dialog functionality for new rows
      initializeTableRowClickHandlers();
    }

    // Create a single table row from entry data
    function createTableRow(entry) {
      const row = document.createElement('div');
      row.className = 'table-row';
      row.style.cursor = 'pointer';

      // Create resources list HTML
      const resourcesHTML = entry.resourcesGiven.map(resource => 
        `<span>${resource}</span>`
      ).join('');

      row.innerHTML = `
        <div class="fixed-columns">
          <div class="column-cell col-date">${entry.date}</div>
          <div class="column-cell col-days">${entry.daysAgo}</div>
          <div class="column-cell col-provider">${entry.provider}</div>
          <div class="column-cell col-client">${entry.client}</div>
        </div>
        <div class="scrollable-columns">
          <div class="column-cell col-service">${entry.placeOfService}</div>
          <div class="column-cell col-accompanied">${entry.accompaniedAppointment}</div>
          <div class="column-cell col-documentation">${entry.obtainedDocumentation}</div>
          <div class="column-cell col-resources">
            <div class="resource-list">
              ${resourcesHTML}
            </div>
          </div>
          <div class="column-cell col-health">${entry.onSiteHealthCare}</div>
          <div class="column-cell col-program">${entry.programStarted}</div>
          <div class="column-cell col-housing">${entry.housingEntered}</div>
          <div class="column-cell col-counted">${entry.countedColumns}</div>
          <div class="column-cell col-notes">${entry.notes}</div>
          <div class="column-cell col-status">${entry.programStatus}</div>
        </div>
      `;

      return row;
    }

    // Initialize click handlers for table rows
    function initializeTableRowClickHandlers() {
      const tableRows = document.querySelectorAll('.table-row:not(:first-child)');
      tableRows.forEach(row => {
        row.addEventListener('click', function(e) {
          e.preventDefault();
          const clientCell = this.querySelector('.fixed-columns .col-client');
          if (clientCell) {
            const clientName = clientCell.textContent.trim();
            showDialog(clientName);
          }
        });
      });
    }

    // Filter table rows based on selected client
    function filterTableByClient(clientName) {
      const rows = document.querySelectorAll('.table-row:not(:first-child)');
      const normalizedSearch = clientName.toLowerCase();
      let foundMatches = false;

      rows.forEach(row => {
        const clientCell = row.querySelector('.fixed-columns .col-client');
        const rowClientName = clientCell.textContent.toLowerCase();

        if (rowClientName.includes(normalizedSearch)) {
          row.style.display = '';
          foundMatches = true;
        } else {
          row.style.display = 'none';
        }
      });
    }

    // Show error message if data loading fails
    function showErrorMessage() {
      const tableRowsContainer = document.querySelector('.table-rows-container');
      const errorRow = document.createElement('div');
      errorRow.className = 'table-row';
      errorRow.innerHTML = `
        <div class="fixed-columns">
          <div class="column-cell" style="color: red; text-align: center; padding: 20px; grid-column: 1 / -1;">
            Error loading contact log data. Please refresh the page or contact support.
          </div>
        </div>
      `;
      tableRowsContainer.appendChild(errorRow);
    }

    // Table drag scrolling functionality
    function initializeTableDragScrolling() {
      const tableContent = document.querySelector('.table-content');
      let isDown = false;
      let startX;
      let scrollLeft;

      tableContent.addEventListener('mousedown', function(e) {
        isDown = true;
        tableContent.style.cursor = 'grabbing';
        startX = e.pageX - tableContent.offsetLeft;
        scrollLeft = tableContent.scrollLeft;
        e.preventDefault();
      });

      tableContent.addEventListener('mouseleave', function() {
        isDown = false;
        tableContent.style.cursor = 'default';
      });

      tableContent.addEventListener('mouseup', function() {
        isDown = false;
        tableContent.style.cursor = 'default';
      });

      tableContent.addEventListener('mousemove', function(e) {
        if (!isDown) return;
        const x = e.pageX - tableContent.offsetLeft;
        const walk = (x - startX) * 1.5;
        tableContent.scrollLeft = scrollLeft - walk;
      });
    }

    // Make showDialog function global so other scripts can use it
    window.showDialog = function(clientName) {
      const dialog = document.getElementById('clientDialog');
      const dialogClientName = document.getElementById('dialogClientName');
      const initialOptionsScreen = document.getElementById('dialogInitialOptions');
      const checkInFormScreen = document.getElementById('dialogCheckInForm');
      
      if (dialog && dialogClientName && initialOptionsScreen && checkInFormScreen) {
        dialogClientName.textContent = clientName;
        initialOptionsScreen.style.display = 'block';
        checkInFormScreen.style.display = 'none';
        dialog.style.display = 'flex';
        dialog.classList.add('show');
        document.body.style.overflow = 'hidden';
      }
    };
  </script>

  <!-- ==========================================================================
       CLIENT DIALOG MODAL (unchanged from your original)
       ========================================================================== -->
  <div id="clientDialog" class="dialog-overlay" style="display: none;">
    <div class="dialog-content">
      <div class="dialog-header">
        <h3 id="dialogClientName">Client Name</h3>
        <button class="dialog-close" id="dialogCloseBtn">&times;</button>
      </div>

      <!-- Initial Options Screen -->
      <div id="dialogInitialOptions" class="dialog-body">
        <p class="dialog-prompt">What would you like to do?</p>
        <div class="dialog-options">
          <button id="quickCheckInBtn" class="btn btn-primary">Quick Check-In</button>
          <button id="addServiceBtn" class="btn btn-primary" style="display: none;">Add Service</button>
          <button id="clientHistoryBtn" class="btn btn-primary">Log History</button>
          <button id="initialCancelBtn" class="btn btn-secondary">Cancel</button>
        </div>
      </div>

      <!-- Check-In Form Screen -->
      <div id="dialogCheckInForm" class="dialog-body" style="display: none;">
        <p class="dialog-prompt">Client objective for visiting today:</p>
        <div class="form-group">
          <div class="multi-select-container" style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
            <div>
              <div class="checkbox-group">
                <label><input type="checkbox" name="objective" value="Case Management"> Case Management (CM)</label>
              </div>
              <div class="checkbox-group">
                <label><input type="checkbox" name="objective" value="Employment"> Employment Services</label>
              </div>
              <div class="checkbox-group">
                <label><input type="checkbox" name="objective" value="Food"> Food</label>
              </div>
              <div class="checkbox-group">
                <label><input type="checkbox" name="objective" value="Healthcare"> Healthcare</label>
              </div>
              <div class="checkbox-group">
                <label><input type="checkbox" name="objective" value="Housing"> Housing Support</label>
              </div>
            </div>
            <div>
              <div class="checkbox-group">
                <label><input type="checkbox" name="objective" value="ID"> ID/Documentation</label>
              </div>
              <div class="checkbox-group">
                <label><input type="checkbox" name="objective" value="Laundry"> Laundry</label>
              </div>
              <div class="checkbox-group">
                <label><input type="checkbox" name="objective" value="Occupational"> Occupational Therapy (OT)</label>
              </div>
              <div class="checkbox-group">
                <label><input type="checkbox" name="objective" value="Recreation"> Recreation</label>
              </div>
              <div class="checkbox-group">
                <label><input type="checkbox" name="objective" value="Other"> Other</label>
              </div>
            </div>
          </div>
        </div>

        <!-- Client accessed food checkbox -->
        <div class="form-group" style="margin-top: 24px; margin-bottom: 24px;">
          <div class="checkbox-group">
            <label><input type="checkbox" name="accessedFood" value="Yes"> Client accessed food</label>
          </div>
        </div>

        <!-- Comments section -->
        <div class="form-group">
          <p class="form-label">Comments:</p>
          <textarea id="visitComments" rows="4" class="form-control" placeholder="Enter any additional notes or comments here..."></textarea>
        </div>

        <!-- Form action buttons -->
        <div class="dialog-options">
          <button id="dialogCancelBtn" class="btn btn-secondary">Cancel</button>
          <button id="dialogSubmitBtn" class="btn btn-primary">Submit</button>
        </div>
      </div>
    </div>
  </div>

  <!-- ==========================================================================
       DIALOG FUNCTIONALITY SCRIPT (unchanged from your original)
       ========================================================================== -->
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      function initializeDialog() {
        const dialog = document.getElementById('clientDialog');
        if (!dialog) {
          console.error('Dialog element not found.');
          return;
        }
        
        const dialogClientName = document.getElementById('dialogClientName');
        const initialOptionsScreen = document.getElementById('dialogInitialOptions');
        const checkInFormScreen = document.getElementById('dialogCheckInForm');
        const quickCheckInBtn = document.getElementById('quickCheckInBtn');
        
        if (!dialogClientName || !initialOptionsScreen || !checkInFormScreen || !quickCheckInBtn) {
          console.error('Dialog content elements not found.');
          return;
        }
        
        // Add event listener for the "Client History" button
        const clientHistoryBtn = document.getElementById('clientHistoryBtn');
        if (clientHistoryBtn) {
          clientHistoryBtn.addEventListener('click', function() {
            const clientName = dialogClientName.textContent;
            window.location.href = `clientLogHistory.html?client=${encodeURIComponent(clientName)}`;
          });
        }
        
        const dialogCloseBtn = document.getElementById('dialogCloseBtn');
        const initialCancelBtn = document.getElementById('initialCancelBtn');
        const dialogCancelBtn = document.getElementById('dialogCancelBtn');
        
        if (dialogCloseBtn) {
          dialogCloseBtn.addEventListener('click', () => {
            dialog.style.display = 'none';
            dialog.classList.remove('show');
            document.body.style.overflow = 'auto';
          });
        }
        
        if (initialCancelBtn) {
          initialCancelBtn.addEventListener('click', () => {
            dialog.style.display = 'none';
            dialog.classList.remove('show');
            document.body.style.overflow = 'auto';
          });
        }
        
        if (dialogCancelBtn) {
          dialogCancelBtn.addEventListener('click', () => {
            dialog.style.display = 'none';
            dialog.classList.remove('show');
            document.body.style.overflow = 'auto';
          });
        }
        
        // Add event listener to Quick Check In button
        if (quickCheckInBtn) {
          quickCheckInBtn.addEventListener('click', () => {
            initialOptionsScreen.style.display = 'none';
            checkInFormScreen.style.display = 'block';
          });
        }
        
        // Add submit button handler
        const dialogSubmitBtn = document.getElementById('dialogSubmitBtn');
        if (dialogSubmitBtn) {
          dialogSubmitBtn.addEventListener('click', () => {
            // Here you would save the form data
            alert('Check-in form submitted successfully!');
            dialog.style.display = 'none';
            dialog.classList.remove('show');
            document.body.style.overflow = 'auto';
          });
        }
      }
      
      // Initialize dialog after a small delay to ensure header is loaded
      setTimeout(initializeDialog, 100); 
    });
  </script>

</body>
</html>
